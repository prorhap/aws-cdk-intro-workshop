+++
title = "Use the hit counter"
weight = 400
+++

## Add a hit counter to our stack

이제 hit counter를 준비 완료했습니다. 우리 앱에서 이것을 사용해볼까요. `lib/cdk-workshop-stack.ts` 를 열어서 다음의 강조 표시된 코드를 추가합니다.

{{<highlight ts "hl_lines=4 16-18 22">}}
import * as cdk from '@aws-cdk/core';
import * as lambda from '@aws-cdk/aws-lambda';
import * as apigw from '@aws-cdk/aws-apigateway';
import { HitCounter } from './hitcounter';

export class CdkWorkshopStack extends cdk.Stack {
  constructor(scope: cdk.App, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    const hello = new lambda.Function(this, 'HelloHandler', {
      runtime: lambda.Runtime.NODEJS_10_X,
      code: lambda.Code.fromAsset('lambda'),
      handler: 'hello.handler'
    });
    
    const helloWithCounter = new HitCounter(this, 'HelloHitCounter', {
      downstream: hello
    });
    
    // defines an API Gateway REST API resource backed by our "hello" function.
    new apigw.LambdaRestApi(this, 'Endpoint', {
      handler: helloWithCounter.handler
    });
  }
}
{{</highlight>}}

API Gateway 핸들러를 `hello` 에서 `helloWithCounter.handler`로 변경했습니다. 이는 기본적으로 엔드포인트에 접근할 때마다 API Gateway는 요청을 hit counter 핸들러로 라우팅하여 hit 을 기록한 뒤 `hello` 함수를 호출한다는 것을 의미합니다. 그런 다음 사용자에게 역순으로 응답이 전달됩니다.



## Deploy

```
cdk deploy
```
이 작업은 시간이 약간 필요합니다.

그리고 실행 결과로 다음의 내용을 확인할 수 있어요.

```
CdkWorkshopStack.Endpoint8024A810 = https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod/
```

## Test

이제 실행할 준비가 되었나요? ("deploy" 실행 결과 화면에서 API의 URL을 확인해야합니다.).

`curl` 또는 웹 브라우저를 사용해서 엔드포인트에 접속합니다. (이 때 HTTP 응답 필드와 상태 코드를 확인하기 위해서 `-i` 옵션을 사용할 수 있습니다.

```
curl -i https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod/
```

으앗! 뭔가 이상이 있네요.

```
HTTP/2 502 Bad Gateway
...

{"message": "Internal server error"}
```

이제 무엇 때문인지 문제가 발생했는지, 어떻게 해결해야 할지 살펴봅시다.

